<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Navigation Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
    }
    #map {
        height: 100%;
        width: 100%;
    }
    .controls {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0px 2px 6px rgba(0,0,0,0.3);
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 5px;
        width: 90%;
        max-width: 300px;
    }
    .controls input, .controls button {
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        outline: none;
    }
    .controls button {
        background: #007bff;
        color: white;
        cursor: pointer;
        border: none;
    }
    .controls button:hover {
        background: #0056b3;
    }
    .info-panel {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 14px;
        z-index: 1000;
    }
    .leaflet-routing-container {
        margin-top: 140px !important;
    }
    @media (max-width: 600px) {
        .controls {
            max-width: 90%;
            font-size: 12px;
        }
        .controls input, .controls button {
            font-size: 12px;
            padding: 6px;
        }
        .leaflet-routing-container {
            margin-top: 190px !important;
        }
    }
    /* Blue animated route style */
    .animated-route {
        stroke-dasharray: 10;
        animation: dash 1s linear infinite;
    }
    @keyframes dash {
        to {
            stroke-dashoffset: -20;
        }
    }
</style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <input type="text" id="from" placeholder="From (place or lat,lon)">
    <input type="text" id="to" placeholder="To (place or lat,lon)">
    <button onclick="setCurrentLocation()">üìç Use Current Location</button>
    <button onclick="getRoute()">üöó Get Directions</button>
    <button onclick="startLiveNavigation()">üì° Start Live Navigation</button>
</div>

<div class="info-panel" id="infoPanel" style="display:none;">
    Distance: <span id="distance"></span> | ETA: <span id="eta"></span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
let map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
}).addTo(map);

let routingControl;
let userMarker;
let watchId;
let toCoordsGlobal = null;
let animatedPolyline;
let currentRotation = 0;

// Custom GPS arrow icon
let arrowIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/64/64113.png',
    iconSize: [35, 35],
    iconAnchor: [17, 17]
});

// Geocode function
function geocode(query, callback) {
    if (query.includes(",")) {
        let parts = query.split(",");
        callback({ lat: parseFloat(parts[0]), lon: parseFloat(parts[1]) });
    } else {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) callback(data[0]);
            else alert("Location not found");
        });
    }
}

// Set current location
function setCurrentLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        let lat = pos.coords.latitude;
        let lon = pos.coords.longitude;
        document.getElementById("from").value = `${lat},${lon}`;
        map.setView([lat, lon], 14);
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lon], { icon: arrowIcon }).addTo(map).bindPopup("You are here").openPopup();
    }, () => {
        alert("Unable to get location");
    });
}

// Draw animated blue route
function drawAnimatedRoute(coords) {
    if (animatedPolyline) map.removeLayer(animatedPolyline);
    animatedPolyline = L.polyline(coords, {
        color: '#007bff',
        weight: 6,
        className: 'animated-route'
    }).addTo(map);
}

// Get route
function getRoute() {
    let from = document.getElementById("from").value;
    let to = document.getElementById("to").value;
    if (!from || !to) {
        alert("Please enter both locations");
        return;
    }

    geocode(from, fromCoords => {
        geocode(to, toCoords => {
            toCoordsGlobal = toCoords;
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(fromCoords.lat, fromCoords.lon),
                    L.latLng(toCoords.lat, toCoords.lon)
                ],
                routeWhileDragging: true,
                geocoder: L.Control.Geocoder.nominatim(),
                addWaypoints: false
            }).on('routesfound', function(e) {
                let route = e.routes[0];
                updateInfo(route.summary.totalDistance, route.summary.totalTime);
                speakDirections(route.instructions || []);
                drawAnimatedRoute(route.coordinates);
            }).addTo(map);
        });
    });
}

// Update ETA & distance
function updateInfo(distanceMeters, timeSeconds) {
    document.getElementById("infoPanel").style.display = "block";
    let distanceKm = (distanceMeters / 1000).toFixed(2) + " km";
    let etaMin = Math.round(timeSeconds / 60) + " mins";
    document.getElementById("distance").innerText = distanceKm;
    document.getElementById("eta").innerText = etaMin;
}

// Voice directions
function speakDirections(instructions) {
    let utterance = new SpeechSynthesisUtterance();
    utterance.lang = 'en-US';
    instructions.forEach(inst => {
        utterance.text = inst.text;
        speechSynthesis.speak(utterance);
    });
}

// Calculate heading between two points
function getBearing(lat1, lon1, lat2, lon2) {
    let dLon = (lon2 - lon1) * Math.PI / 180;
    lat1 = lat1 * Math.PI / 180;
    lat2 = lat2 * Math.PI / 180;
    let y = Math.sin(dLon) * Math.cos(lat2);
    let x = Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;
    return (brng + 360) % 360;
}

// Smooth rotation
function smoothRotate(newRotation) {
    let diff = (newRotation - currentRotation + 540) % 360 - 180;
    currentRotation = (currentRotation + diff * 0.2) % 360; // Smooth factor
    return currentRotation;
}

// Live navigation
function startLiveNavigation() {
    if (!document.getElementById("to").value) {
        alert("Enter destination first");
        return;
    }
    if (watchId) navigator.geolocation.clearWatch(watchId);

    let lastLat = null, lastLon = null;

    watchId = navigator.geolocation.watchPosition(pos => {
        let lat = pos.coords.latitude;
        let lon = pos.coords.longitude;

        let rotation = 0;
        if (lastLat !== null && lastLon !== null) {
            rotation = getBearing(lastLat, lastLon, lat, lon);
            rotation = smoothRotate(rotation);
        }
        lastLat = lat;
        lastLon = lon;

        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lat, lon], {
            icon: arrowIcon,
            rotationAngle: rotation
        }).addTo(map);

        map.setView([lat, lon], 16);

        if (toCoordsGlobal) {
            if (routingControl) map.removeControl(routingControl);
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(lat, lon),
                    L.latLng(toCoordsGlobal.lat, toCoordsGlobal.lon)
                ],
                routeWhileDragging: false,
                geocoder: L.Control.Geocoder.nominatim(),
                addWaypoints: false
            }).on('routesfound', function(e) {
                let route = e.routes[0];
                updateInfo(route.summary.totalDistance, route.summary.totalTime);
                speakDirections(route.instructions || []);
                drawAnimatedRoute(route.coordinates);
            }).addTo(map);
        }
    }, () => {
        alert("Error in live tracking");
    }, { enableHighAccuracy: true });
}
</script>

</body>
</html>
