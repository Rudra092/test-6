<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>EasyMap — Realtime map & directions</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    #map { height: 80vh; width: 100%; }
    header { background:#222; color:white; padding:10px 16px; display:flex; align-items:center; gap:12px; }
    .controls { padding:12px; display:flex; gap:8px; align-items:center; }
    button { padding:6px 10px; border-radius:6px; border: none; background:#1976d2; color:white; cursor:pointer; }
    input { padding:6px 8px; border-radius:6px; border:1px solid #ccc; }
    .small { font-size:0.85rem; color:#eee; opacity:0.9 }
    #info { padding:8px 12px; background:#fff; border-top:1px solid #ddd; }
  </style>
</head>
<body>

<header>
  <div style="font-weight:700">EasyMap</div>
  <div class="small">(Leaflet + OSRM routing via backend)</div>
</header>

<div class="controls">
  <button id="locBtn">Use My Location</button>
  <button id="clearBtn">Clear Markers</button>
  <label>From: <input id="fromInput" placeholder="click on map or type lat,lng"></label>
  <label>To: <input id="toInput" placeholder="click on map or type lat,lng"></label>
  <button id="routeBtn">Get Directions</button>
  <button id="saveBtn">Save Route</button>
</div>

<div id="map"></div>
<div id="info">Distance: <span id="distance">—</span> • Duration: <span id="duration">—</span></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const BACKEND = (location.hostname === 'localhost') ? 'http://localhost:4000' : 'https://your-backend.onrender.com';
// replace 'https://your-backend.onrender.com' with your Render backend URL after deploy

// initialize map
const map = L.map('map').setView([20.5937, 78.9629], 5); // default to India
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '© OpenStreetMap'
}).addTo(map);

let fromMarker = null, toMarker = null, routeLayer = null;

// helper to parse input like "12.34,56.78"
function parseLatLng(s) {
  if(!s) return null;
  const parts = s.split(',').map(p=>p.trim());
  if(parts.length!==2) return null;
  const lat = parseFloat(parts[0]), lng = parseFloat(parts[1]);
  if(Number.isFinite(lat) && Number.isFinite(lng)) return [lat,lng];
  return null;
}

// click to set origin/destination
map.on('click', (e) => {
  // alternate behavior: ctrl-click sets 'from', plain click sets 'to'
  if (window._lastClickMode === 'from') {
    setFrom(e.latlng);
  } else {
    setTo(e.latlng);
  }
});

// toggle mode by clicking inputs
document.getElementById('fromInput').addEventListener('focus', ()=> window._lastClickMode='from');
document.getElementById('toInput').addEventListener('focus', ()=> window._lastClickMode='to');
// default to 'to' so normal clicks place destination
window._lastClickMode = 'to';

function setFrom(latlng) {
  if (fromMarker) map.removeLayer(fromMarker);
  fromMarker = L.marker(latlng, {draggable:true}).addTo(map).bindPopup('From').openPopup();
  fromMarker.on('dragend', ()=> updateInputsFromMarkers());
  document.getElementById('fromInput').value = `${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`;
}

function setTo(latlng) {
  if (toMarker) map.removeLayer(toMarker);
  toMarker = L.marker(latlng, {draggable:true}).addTo(map).bindPopup('To').openPopup();
  toMarker.on('dragend', ()=> updateInputsFromMarkers());
  document.getElementById('toInput').value = `${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`;
}

function updateInputsFromMarkers() {
  if(fromMarker) {
    const p = fromMarker.getLatLng();
    document.getElementById('fromInput').value = `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
  }
  if(toMarker) {
    const p = toMarker.getLatLng();
    document.getElementById('toInput').value = `${p.lat.toFixed(6)},${p.lng.toFixed(6)}`;
  }
}

document.getElementById('clearBtn').addEventListener('click', () => {
  if(fromMarker) { map.removeLayer(fromMarker); fromMarker = null; }
  if(toMarker) { map.removeLayer(toMarker); toMarker = null; }
  if(routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
  document.getElementById('distance').textContent = '—';
  document.getElementById('duration').textContent = '—';
  document.getElementById('fromInput').value = '';
  document.getElementById('toInput').value = '';
});

document.getElementById('locBtn').addEventListener('click', ()=> {
  // get current location
  if(!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(pos => {
    const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    map.setView(latlng, 14);
    setFrom(latlng);
  }, err => alert('Could not get location: ' + err.message));
});

document.getElementById('routeBtn').addEventListener('click', async ()=> {
  // read from inputs
  const a = parseLatLng(document.getElementById('fromInput').value) || (fromMarker && [fromMarker.getLatLng().lat, fromMarker.getLatLng().lng]);
  const b = parseLatLng(document.getElementById('toInput').value) || (toMarker && [toMarker.getLatLng().lat, toMarker.getLatLng().lng]);
  if(!a || !b) return alert('Please set both From and To (click map or type lat,lng).');

  // show loading
  document.getElementById('distance').textContent = 'Loading...';
  document.getElementById('duration').textContent = 'Loading...';

  try {
    const start = `${a[1]},${a[0]}`; // lon,lat for OSRM
    const end = `${b[1]},${b[0]}`;
    const res = await fetch(`${BACKEND}/route?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`);
    if(!res.ok) throw new Error('Routing failed: ' + res.statusText);
    const data = await res.json();
    // data: { distance_meters, duration_seconds, geometry: GeoJSON LineString }
    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer = L.geoJSON(data.geometry, { style: { color: '#1976d2', weight: 5 } }).addTo(map);
    map.fitBounds(routeLayer.getBounds().pad(0.2));
    document.getElementById('distance').textContent = (data.distance_meters/1000).toFixed(2) + ' km';
    const mins = Math.round(data.duration_seconds/60);
    document.getElementById('duration').textContent = mins + ' min';
  } catch (err) {
    alert(err.message || String(err));
    document.getElementById('distance').textContent = '—';
    document.getElementById('duration').textContent = '—';
  }
});

document.getElementById('saveBtn').addEventListener('click', async ()=> {
  if(!routeLayer) return alert('No route to save. Generate a route first.');
  const name = prompt('Give a name for this route (optional)');
  const geo = routeLayer.toGeoJSON();
  try {
    const res = await fetch(`${BACKEND}/save-route`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name: name||'Unnamed route', geo })
    });
    const j = await res.json();
    alert(j.message || 'Saved');
  } catch (err) {
    alert('Save failed: ' + err.message);
  }
});

// allow manual paste of coordinates to set markers quickly
document.getElementById('fromInput').addEventListener('change', (e)=>{
  const v = parseLatLng(e.target.value);
  if(v) setFrom({lat:v[0], lng:v[1]});
});
document.getElementById('toInput').addEventListener('change', (e)=>{
  const v = parseLatLng(e.target.value);
  if(v) setTo({lat:v[0], lng:v[1]});
});

// optional: load saved routes list (simple)
async function loadSavedRoutesList() {
  try {
    const res = await fetch(`${BACKEND}/routes`);
    if(!res.ok) return;
    const list = await res.json();
    if(list.length===0) return;
    // place first saved route on map (for demo)
    console.log('Saved routes:', list);
  } catch(e) { /* ignore */ }
}
loadSavedRoutesList();

</script>
</body>
</html>
